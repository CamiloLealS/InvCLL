<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario CLL</title>
    <link rel="shortcut icon" href="{% static 'img/favicon.ico' %}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">    
    <link rel="stylesheet" href="{% static 'estilos.css' %}">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
</head>
<body style="background: rgb(220,228,242);
background: radial-gradient(circle, rgba(220,228,242,1) 0%, rgba(158,227,225,1) 100%);">
    <header class="shadow-lg p-3 mb-5"
        style="background: rgb(14,81,137);
    background: linear-gradient(90deg, rgba(14,81,137,1) 0%, rgba(7,148,192,1) 59%, rgba(0,211,255,0.9641106442577031) 100%);">
        <div class="navbar">
            <a href="{% url 'index' %}"><img src= "{% static 'img/logo.png' %}" alt="logo_cll" height="100px" width="300px"></a>
            <span><h1>Inventario de Equipos</h1></span>
            <a href=""></a>
        </div>
    </header>
    <br>
    <div class="container">
        <div class="card-table">
            <form method="get">
                <div class="container" id="cont-tabla">
                    <section class = "search-cont">
                        <input onclick="table()" type="search" placeholder="Buscar equipo" id="buscar">
                        <p style="display: inline; margin-left: 3px;" for="tipos">Filtrar por:</p>
                        <select id="tip" onclick="filtSel('#tip')" name="tipo">
                            <option value="Tipo de Equipo">Tipo de Equipo</option>
                            <option value="COMPUTADOR">COMPUTADOR</option>
                            <option value="IMPRESORA">IMPRESORA</option>
                        </select>
                        <p style="display: inline; margin-left: 3px;" for="order">Mantención:</p>
                        <select onclick="filtMant('#ord')" name="order" id="ord">
                            <option value="">-</option>
                            <option value="PENDIENTE">Pendiente</option>
                            <option value="REALIZADA">Realizada</option>
                        </select>
                    </section>
                    <section id="title-table">
                        <br>
                        <h4 id="titleTab">Inventario De Equipos</h4>
                        <hr>
                    </section>
                    <table class="table table-hover table-bordered" style="border: 1px rgb(91, 91, 91);width: 100%;" id="table">
                        <thead id="tHead">
                            <tr>
                                <th scope="col">ID</th>
                                <th scope="col">Ubicación</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">IP</th>
                                <th scope="col">MAC</th>
                                <th id="colops" scope="col">Opciones</th>
                            </tr>
                        </thead>
                        <tbody id="bodyTable">
                            {% for item in object_list %}
                                <a href="">
                                    <tr>
                                        <th scope="row">{{ item.id_equipo }}</th>
                                        <th scope="row">{{ item.ubicacion }}</th>
                                        <th scope="row">{{ item.tipo }}</th>
                                        <th scope="row">{{ item.ip }}</th>
                                        <th scope="row">{{ item.mac }}</th>
                                        <th id="ops" scope="row"><a class="btn btn-danger" href="{% url 'delete' item.id_equipo %}"><img src="{% static 'img/del.png' %}" height="21px" width="19px" alt=""></a></th>   
                                    </tr>
                                </a>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button class="btn btn-dark" id="btnExport" onclick="exportTableToExcel('table','Reporte-Equipos '+fecha())">Exportar a Excel</button>
                    <a class="btn btn-dark" href="{% url 'import' %}">Importar Excel</a>
                    <a class="btn btn-dark" href="{% url 'regEq' %}">Registrar Equipo Manualmente</a>
                </div>
            </form>   
        </div>
    </div>
    <script>
       function table(){
            const data = "{{qs_json}}";

            const rdata = JSON.parse(data.replace(/&quot;/g, '"'));
            console.log(rdata)

            const input = document.getElementById('buscar');
            ord.value = '';
            tip.value = 'Tipo de Equipo';
            let filteredArr = [];

            input.addEventListener('keyup',(e)=>{
                tHead.innerHTML = `<tr>
                                <th scope="col">ID</th>
                                <th scope="col">Ubicación</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">IP</th>
                                <th scope="col">MAC</th>
                                <th scope="col">Mantención</th>
                                <th id="colops" scope="col">Opciones</th>
                            </tr>`;
                bodyTable.innerHTML = "";
                titleTab.innerHTML = "Inventario de Equipos";
                filteredArr = rdata.filter(info => info['ubicacion'].includes(e.target.value.toUpperCase()));
                
                if(filteredArr.length > 0){
                    filteredArr.map(item=>{
                        bodyTable.innerHTML += `<a href = ""><tr><th scope="row">${item['id_equipo']}</th>
                                            <th scope="row">${item['ubicacion']}</th>
                                            <th scope="row">${item['tipo']}</th>
                                            <th scope="row">${item['ip']}</th>
                                            <th scope="row">${item['mac']}</th>
                                            <th id="mant" scope="row">${item['mantencion']} | ${item['estadoMant']}</th>
                                            <th id="ops" scope="row"><a style="margin-left: 2px; margin-right: 2px;" class="btn btn-primary" href = "upd/${item['id_equipo']}">Status</a><a class="btn btn-danger" href="del/${item['id_equipo']}"><img src="{% static 'img/del.png' %}" height="21px" width="19px" alt=""></a></th>
                                            </tr></a>`
                    });
                };
            });
        };

    </script>
    <script>
        function filtSel(sec){
            const $sel = document.querySelector(sec);
            const data = "{{qs_json}}";

            const rdata = JSON.parse(data.replace(/&quot;/g, '"'));
            console.log(rdata)

            let filteredArr = [];
            ord.value = '';
            buscar.value = '';            
            $sel.addEventListener("change", (e)=>{
                tHead.innerHTML = `<tr>
                                <th scope="col">ID</th>
                                <th scope="col">Ubicación</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">IP</th>
                                <th scope="col">MAC</th>
                                <th scope="col">Mantención</th>
                                <th id="colops" scope="col">Opciones</th>
                            </tr>`;
                bodyTable.innerHTML = "";
                titleTab.innerHTML = "";
                if (e.target.value == "Tipo de Equipo"){
                    filteredArr = rdata;
                }else{
                    filteredArr = rdata.filter(info => info['tipo'] == e.target.value);
                };
                if(filteredArr.length > 0){
                    filteredArr.map(item=>{
                        bodyTable.innerHTML += `<a href = ""><tr><th scope="row">${item['id_equipo']}</th>
                                            <th scope="row">${item['ubicacion']}</th>
                                            <th scope="row">${item['tipo']}</th>
                                            <th scope="row">${item['ip']}</th>
                                            <th scope="row">${item['mac']}</th>
                                            <th id="mant" scope="row">${item['mantencion']} | ${item['estadoMant']}</th>
                                            <th id="ops" scope="row"><a style="margin-left: 2px; margin-right: 2px;" class="btn btn-primary" href = "upd/${item['id_equipo']}" >Status</a><a class="btn btn-danger" href="del/${item['id_equipo']}"><img src="{% static 'img/del.png' %}" height="21px" width="19px" alt=""></a></th>
                                            </tr></a>`
                    });
                if (e.target.value == 'COMPUTADOR'){
                    titleTab.innerHTML +=`<h4>Inventario de Equipos | COMPUTADORES </h4>`
                }else if(e.target.value == 'IMPRESORA'){
                    titleTab.innerHTML +=`<h4>Inventario de Equipos | IMPRESORAS</h4>`
                }else{
                    titleTab.innerHTML +=`<h4>Inventario de Equipos</h4>`
                }
                    
                    console.log(filteredArr); 
                };
                //'AEFFA8'
                //'F76666'
            });
        };
    </script>
    <script>
        function filtMant(sec){
            const $ord = document.querySelector(sec);
            const data = "{{qs_json}}";
            const fecha = new Date();

            const rdata = JSON.parse(data.replace(/&quot;/g, '"'));
            console.log(rdata)
            tip.value = 'Tipo de Equipo';
            buscar.value = '';
            let filteredArr = [];
            
            $ord.addEventListener("change", (e)=>{
                tHead.innerHTML = `<tr>
                                <th scope="col">ID</th>
                                <th scope="col">Ubicación</th>
                                <th scope="col">Tipo</th>
                                <th scope="col">IP</th>
                                <th scope="col">MAC</th>
                                <th scope="col">Mantención</th>
                                <th id="colops" scope="col">Opciones</th>
                            </tr>`;
                bodyTable.innerHTML = "";
                titleTab.innerHTML = "Inventario de Equipos";
                if (e.target.value == ""){
                    filteredArr = rdata;
                }else{
                    filteredArr = rdata.filter(info => info['estadoMant'] == e.target.value);
                };
                if(filteredArr.length > 0){
                    filteredArr.map(item=>{
                        bodyTable.innerHTML += `<a href = ""><tr><th scope="row">${item['id_equipo']}</th>
                                            <th scope="row">${item['ubicacion']}</th>
                                            <th scope="row">${item['tipo']}</th>
                                            <th scope="row">${item['ip']}</th>
                                            <th scope="row">${item['mac']}</th>
                                            <th id="mant" scope="row">${item['mantencion']} | ${item['estadoMant']}</th>
                                            <th id="ops" scope="row"><a style="margin-left: 2px; margin-right: 2px;" class="btn btn-primary" href = "upd/${item['id_equipo']}" >Status</a><a class="btn btn-danger" href="del/${item['id_equipo']}"><img src="{% static 'img/del.png' %}" height="21px" width="19px" alt=""></a></th>
                                            </tr></a>`
                    });
                };
                if(e.target.value !== ''){
                    const rows = Array.from(bodyTable.rows);
                    console.log(rows);
                    var sortedRows = rows.sort(function(a,b){
                        const aText1 = a.cells[5].textContent;
                        const aText = aText1.split(' | ')[0];
                        const bText2 = b.cells[5].textContent;
                        const bText = bText2.split(' | ')[0];
                        const aDate = aText.split('/').reverse().join();
                        const bDate = bText.split('/').reverse().join();
                        return new Date(aDate) - new Date(bDate);
                    });
                    bodyTable.innerHTML = "";
                    sortedRows.forEach(row =>{
                        bodyTable.appendChild(row);
                    });
                };
            });
        };
    </script>
    <script type="text/javascript">
        function exportTableToExcel(tableID, filename = ''){
            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');
    
            // Specify file name
            filename = filename?filename+'.xls':'excel_data.xls';
    
            // Create download link element
            downloadLink = document.createElement("a");
    
            document.body.appendChild(downloadLink);
    
            if(navigator.msSaveOrOpenBlob){
                var blob = new Blob(['\ufeff', tableHTML], {
                    type: dataType
                });
                navigator.msSaveOrOpenBlob( blob, filename);
            }else{
                // Create a link to the file
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
    
                // Setting the file name
                downloadLink.download = filename;
        
                //triggering the function
                colops.textContent = '';
                downloadLink.click();
            }
        }
    </script>
    <script type="text/javascript">
        function fecha(){
            const fecha = new Date();

            return fecha.toLocaleDateString();
        }
    </script>
</body>
</html>